<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Business Insights Service - Architecture Diagram</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .diagram-container {
            padding: 40px;
            background: #f8f9fa;
            position: relative;
            overflow-x: auto;
        }
        
        .architecture-diagram {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(6, auto);
            gap: 20px;
            min-width: 1200px;
            padding: 20px;
        }
        
        .component {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .component:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .scheduler { border-left-color: #e74c3c; grid-column: 1; }
        .service { border-left-color: #3498db; }
        .database { border-left-color: #2ecc71; }
        .email { border-left-color: #f39c12; }
        .monitoring { border-left-color: #9b59b6; }
        
        .component-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .component-details {
            font-size: 0.9em;
            color: #7f8c8d;
            line-height: 1.4;
        }
        
        .tech-specs {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.8em;
            font-family: 'Courier New', monospace;
        }
        
        .flow-arrow {
            position: absolute;
            color: #3498db;
            font-size: 2em;
            font-weight: bold;
            z-index: 10;
        }
        
        .arrow-right { transform: rotate(0deg); }
        .arrow-down { transform: rotate(90deg); }
        
        .data-flow {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .table-schema {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            margin-top: 10px;
            overflow-x: auto;
        }
        
        .json-structure {
            background: #34495e;
            color: #1abc9c;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            margin-top: 8px;
            white-space: pre-wrap;
        }
        
        .schedule-badge {
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            display: inline-block;
            margin-top: 8px;
        }
        
        .optimization-tag {
            background: #27ae60;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            display: inline-block;
            margin: 2px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .active-process {
            animation: pulse 2s infinite;
        }
        
        .grid-row-1 { grid-row: 1; }
        .grid-row-2 { grid-row: 2; }
        .grid-row-3 { grid-row: 3; }
        .grid-row-4 { grid-row: 4; }
        .grid-row-5 { grid-row: 5; }
        .grid-row-6 { grid-row: 6; }
        
        .grid-col-1 { grid-column: 1; }
        .grid-col-2 { grid-column: 2; }
        .grid-col-3 { grid-column: 3; }
        .grid-col-4 { grid-column: 4; }
        .grid-col-span-2 { grid-column: span 2; }
        .grid-col-span-4 { grid-column: span 4; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Weekly Business Insights Service</h1>
            <p>Technical Architecture & Implementation Plan</p>
        </div>
        
        <div class="diagram-container">
            <div class="architecture-diagram">
                
                <!-- Row 1: Schedulers -->
                <div class="component scheduler grid-row-1 grid-col-1">
                    <div class="component-title">üìÖ Weekly Insights Command</div>
                    <div class="component-details">
                        Laravel console command that dispatches job chain
                    </div>
                    <div class="schedule-badge">Every Friday 4:00 AM (Asia/Riyadh)</div>
                    <div class="tech-specs">
                        WeeklyInsightsCommand<br>
                        ‚Ä¢ Dispatches GenerateWeeklyInsightsJob<br>
                        ‚Ä¢ OnSuccess ‚Üí SendWeeklyInsightsJob<br>
                        ‚Ä¢ Job chain pattern
                    </div>
                </div>
                
                <div class="component scheduler grid-row-1 grid-col-2">
                    <div class="component-title">‚õìÔ∏è Job Chain Processing</div>
                    <div class="component-details">
                        Chained job execution pattern for reliability
                    </div>
                    <div class="schedule-badge">Queued Processing</div>
                    <div class="tech-specs">
                        Bus::chain([<br>
                        &nbsp;&nbsp;GenerateWeeklyInsightsJob,<br>
                        &nbsp;&nbsp;SendWeeklyInsightsJob<br>
                        ])->dispatch();<br>
                        ‚Ä¢ Automatic failure handling<br>
                        ‚Ä¢ Sequential execution
                    </div>
                </div>
                
                <!-- Row 2: Job Services -->
                <div class="component service grid-row-2 grid-col-1">
                    <div class="component-title">‚öôÔ∏è Generate Weekly Insights Job</div>
                    <div class="component-details">
                        First job in chain - processes all companies data
                    </div>
                    <div class="tech-specs">
                        GenerateWeeklyInsightsJob<br>
                        <span class="optimization-tag">Queue Processing</span>
                        <span class="optimization-tag">Chunked Companies</span>
                        <span class="optimization-tag">Per-tenant Cache</span>
                    </div>
                    <div class="json-structure">Process:
‚Ä¢ Chunk companies (500 per batch)
‚Ä¢ Dispatch InsightsCalculationService
‚Ä¢ Cache per-tenant during execution
‚Ä¢ Delete cache after completion</div>
                </div>
                
                <div class="component service grid-row-2 grid-col-2">
                    <div class="component-title">üìß Send Weekly Insights Job</div>
                    <div class="component-details">
                        Second job in chain - sends emails after data generation
                    </div>
                    <div class="tech-specs">
                        SendWeeklyInsightsJob<br>
                        ‚Ä¢ Batch size: 50 emails<br>
                        ‚Ä¢ 30s delay between batches<br>
                        ‚Ä¢ Only runs after successful generation
                    </div>
                </div>
                
                <!-- Row 3: Core Services -->
                <div class="component service grid-row-3 grid-col-1">
                    <div class="component-title">‚öôÔ∏è Insights Calculation Service</div>
                    <div class="component-details">
                        Core business logic for metric calculations
                    </div>
                    <div class="tech-specs">
                        InsightsCalculationService<br>
                        <span class="optimization-tag">Async Processing</span>
                        <span class="optimization-tag">Database Transactions</span>
                        <span class="optimization-tag">Per-tenant Caching</span>
                    </div>
                    <div class="json-structure">Methods:
‚Ä¢ calculateRevenue()
‚Ä¢ calculateExpenses() 
‚Ä¢ calculatePurchases()
‚Ä¢ calculateNetProfit()
‚Ä¢ calculateOverduePayments()

Cache Management:
‚Ä¢ Cache during execution
‚Ä¢ Delete cache after completion</div>
                </div>
                
                <div class="component service grid-row-3 grid-col-2">
                    <div class="component-title">üìß Email Template Engine</div>
                    <div class="component-details">
                        Multi-language email template generation
                    </div>
                    <div class="tech-specs">
                        InsightsEmailTemplate<br>
                        ‚Ä¢ Arabic/English support<br>
                        ‚Ä¢ Currency formatting<br>
                        ‚Ä¢ Template caching
                    </div>
                </div>
                <!-- Row 4: Database Architecture -->
                <div class="component database grid-row-4 grid-col-1 grid-col-span-2">
                    <div class="component-title">üóÑÔ∏è Main Database - weekly_insights_log</div>
                    <div class="component-details">
                        Central logging and tracking table (Simplified Schema)
                    </div>
                    <div class="table-schema">
CREATE TABLE weekly_insights_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    week_id VARCHAR(8) UNIQUE NOT NULL,
    week_start_date DATE NOT NULL,
    week_end_date DATE NOT NULL,
    total_emails_sent INT DEFAULT 0,
    total_emails_failed INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP 
                      ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_week_id (week_id),
    INDEX idx_week_dates (week_start_date, week_end_date)
);
                    </div>
                </div>
                
                <div class="component database grid-row-4 grid-col-3 grid-col-span-2">
                    <div class="component-title">üè¢ Per-Tenant Database - tenant_insights</div>
                    <div class="component-details">
                        Individual tenant calculation results (Updated Schema)
                    </div>
                    <div class="table-schema">
CREATE TABLE tenant_insights (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    week_id VARCHAR(8) NOT NULL,
    week_start_date DATE NOT NULL,
    week_end_date DATE NOT NULL,
    company_id BIGINT NOT NULL,
    insights_data JSON NOT NULL,
    email_sent_at TIMESTAMP NULL,
    email_delivery_status ENUM('pending', 'sent', 'failed') 
                          DEFAULT 'pending',
    email_failure_reason TEXT NULL,
    calculation_duration_ms INT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP 
              ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    UNIQUE KEY unique_week_company (week_id, company_id)
);
                    </div>
                    <div class="json-structure">insights_data JSON:
{
  "revenue": 125000.50,
  "expenses": 45000.25,
  "purchases": 30000.00,
  "net_profit": 80000.25,
  "overdue_payments": {
    "0_30_days": 15000,
    "31_60_days": 8000,
    "60_plus_days": 3000
  }
}</div>
                </div>
                
                <!-- Row 5: Data Flow -->
                <div class="data-flow grid-row-5">
                    <h3>üìä Weekly Data Processing Flow</h3>
                    <p><strong>Thursday 11:59 PM ‚Üí Next Thursday 11:59 PM</strong></p>
                    <div style="display: flex; justify-content: space-around; align-items: center; margin-top: 20px;">
                        <div>1. Console Command</div>
                        <div>‚Üí</div>
                        <div>2. Generate Job Chain</div>
                        <div>‚Üí</div>
                        <div>3. Calculate Insights</div>
                        <div>‚Üí</div>
                        <div>4. Send Emails</div>
                        <div>‚Üí</div>
                        <div>5. Clean Historical Data</div>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9em;">
                        <strong>Deployment Steps:</strong>
                        <span style="margin-left: 20px;">1. Command & Service Testing</span>
                        <span style="margin-left: 20px;">2. Multi-tenant Job</span>
                        <span style="margin-left: 20px;">3. Email Implementation</span>
                        <span style="margin-left: 20px;">4. Logging System</span>
                        <span style="margin-left: 20px;">5. Data Cleanup</span>
                    </div>
                </div>
                
                <!-- Row 6: Performance Optimizations -->
                <div class="component service grid-row-6 grid-col-1">
                    <div class="component-title">üöÄ Queue & Processing</div>
                    <div class="component-details">
                        Job queue optimization strategies
                    </div>
                    <div class="tech-specs">
                        <span class="optimization-tag">Chunked Processing</span>
                        <span class="optimization-tag">Queue Delays</span>
                        <span class="optimization-tag">Job Chaining</span>
                        <span class="optimization-tag">Failure Handling</span>
                    </div>
                    <div class="json-structure">Configuration:
‚Ä¢ Companies per chunk: 500
‚Ä¢ Queue with delays
‚Ä¢ Chain jobs pattern
‚Ä¢ Continue on individual failures</div>
                </div>
                
                <div class="component service grid-row-6 grid-col-2">
                    <div class="component-title">üíæ Cache Management</div>
                    <div class="component-details">
                        Per-tenant caching strategy
                    </div>
                    <div class="tech-specs">
                        <span class="optimization-tag">Per-tenant Cache</span>
                        <span class="optimization-tag">Auto Cleanup</span>
                        <span class="optimization-tag">Reference Data</span>
                        <span class="optimization-tag">Template Cache</span>
                    </div>
                    <div class="json-structure">Cache Lifecycle:
‚Ä¢ Cache during calculation
‚Ä¢ Delete after service completion
‚Ä¢ Reference data caching
‚Ä¢ Template caching</div>
                </div>
                
                <div class="component service grid-row-6 grid-col-3">
                    <div class="component-title">üìß Email Batching</div>
                    <div class="component-details">
                        Email delivery optimization
                    </div>
                    <div class="tech-specs">
                        <span class="optimization-tag">Batch Size: 50</span>
                        <span class="optimization-tag">30s Delays</span>
                        <span class="optimization-tag">Failure Tracking</span>
                        <span class="optimization-tag">Queue Integration</span>
                    </div>
                    <div class="json-structure">Email Flow:
‚Ä¢ Batch processing
‚Ä¢ Rate limiting
‚Ä¢ Failed email queuing
‚Ä¢ Retry mechanism</div>
                </div>
                
                <div class="component service grid-row-6 grid-col-4">
                    <div class="component-title">üßπ Data Cleanup</div>
                    <div class="component-details">
                        Historical data management
                    </div>
                    <div class="tech-specs">
                        <span class="optimization-tag">Historical Cleanup</span>
                        <span class="optimization-tag">Storage Optimization</span>
                        <span class="optimization-tag">Automated Process</span>
                        <span class="optimization-tag">Data Retention</span>
                    </div>
                    <div class="json-structure">Cleanup Strategy:
‚Ä¢ Delete old weekly_insights
‚Ä¢ Maintain audit trail
‚Ä¢ Automated scheduling
‚Ä¢ Storage optimization</div>
                </div>
                
                <!-- Row 7: Monitoring & KPIs -->
                <div class="component monitoring grid-row-7 grid-col-span-4">
                    <div class="component-title">üìà Monitoring & Key Performance Indicators</div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                        <div class="performance-metrics">
                            <div class="metric-card">
                                <div class="metric-value">500</div>
                                <div class="metric-label">Companies per Chunk</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">50</div>
                                <div class="metric-label">Emails per Batch</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">30s</div>
                                <div class="metric-label">Batch Delay</div>
                            </div>
                        </div>
                        <div>
                            <div class="json-structure">Laravel Schedule:
$schedule->command('weekly-insights')
         ->weekly('4:00')
         ->timezone('Asia/Riyadh');

Console Command Structure:
‚Ä¢ WeeklyInsightsCommand
‚Ä¢ Dispatches job chain
‚Ä¢ Error handling & logging</div>
                        </div>
                    </div>
                    <div class="json-structure">Monitoring Log Structure:
{
  "week_id": "2025-30",
  "processing_duration_ms": 45000,
  "companies_processed": 1250,
  "emails_sent": 3500,
  "emails_delivered": 3450,
  "emails_failed": 50,
  "average_calculation_time_ms": 36,
  "memory_peak_mb": 512,
  "retry_attempts": 15
}

Deployment & Testing Steps:
1. Command and Service Implementation ‚Üí Database testing for accurate weekly_insights data
2. Multi-tenant job processing ‚Üí Queue system testing
3. Email sending implementation ‚Üí Template and delivery testing  
4. Email delivery logging ‚Üí Tracking and monitoring setup
5. Historical data cleanup ‚Üí Storage optimization implementation</div>
                </div>
                
            </div>
        </div>
    </div>
    
    <script>
        // Add some interactive animations
        document.addEventListener('DOMContentLoaded', function() {
            const components = document.querySelectorAll('.component');
            
            // Stagger the initial animation
            components.forEach((component, index) => {
                component.style.opacity = '0';
                component.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    component.style.transition = 'all 0.6s ease';
                    component.style.opacity = '1';
                    component.style.transform = 'translateY(0)';
                }, index * 100);
            });
            
            // Add click handlers for detailed views
            components.forEach(component => {
                component.addEventListener('click', function() {
                    this.classList.toggle('active-process');
                });
            });
            
            // Simulate live processing indicators
            setInterval(() => {
                const schedulers = document.querySelectorAll('.scheduler');
                schedulers.forEach(scheduler => {
                    scheduler.classList.toggle('active-process');
                });
            }, 3000);
        });
    </script>
</body>
</html>
